#!/bin/lua
------------------------------------------
--- CHANGE THESE FOR YOUR OWN PROJECTS ---
------------------------------------------
project = "sandbox"
starrydir = "."
builddir = "build"
assetssrc = "sandbox/assets"
assetsdst = "build/bin/assets"

imgui_enabled = true

srcs = {
	"sandbox/src/main.cpp",
	"sandbox/src/app.cpp",
	"sandbox/src/debug_mode.cpp",
	"sandbox/src/world.cpp",
}

includes = {
	"sandbox/src"
}

-------------------------
--- ACTUAL BUILD CRAP ---
-------------------------
io.write("Starry3D auto configurator 3000++\n")

io.write("Compile mode (debug/release): ")
compmode = io.read("*l")
assert(compmode == "debug" or compmode == "release")

io.write("Target platform (windows/linux, windows requires mingw-w64 gcc and g++): ")
platform = io.read("*l")
assert(platform == "linux" or platform == "windows")

io.write("Use a sanitizer? (e.g. 'address' for asan, press enter to not use one): ")
sanitize = io.read("*l")

io.write("Generate compile_commands.json for clangd? (y/n): ")
compile_commands = io.read("*l")
assert(compile_commands == "y" or compile_commands == "n")

io.write("\nGenerating...\n")

----------------------------------------------------------------
--- GETTING THE CRAP INFO SO IT CAN ACTUALLY GENERATE FRFRFR ---
----------------------------------------------------------------

cxx = "clang++"
if platform == "windows" then
	cxx = "x86_64-w64-mingw32-g++"
end

-- TODO consider not
cflags = ""
if (platform == "windows") then
	cflags = "-std=c++17 -Wall -Wextra -Wpedantic "
else
	cflags =
	    "-std=c++17 -Wall -Wextra -Wpedantic -Wuninitialized -Wshadow -Wconversion " ..
	    "-Wold-style-cast -Wextra-semi -Wmissing-noreturn -Wimplicit-fallthrough " ..
	    "-Wnull-dereference -Wcast-qual "
end

-- includes
cflags = cflags ..
    " -I"..starrydir ..
    " -I"..starrydir.."/thirdparty" ..
    " -I"..starrydir.."/thirdparty/libtrippin"..
    " -I"..starrydir.."/thirdparty/glfw/include"

if imgui_enabled then
	cflags = cflags.." -I"..starrydir.."/thirdparty/imgui"
end

-- custom includes
for _, include in ipairs(includes) do
	cflags = cflags.." -I"..include
end

-- source files
srcsfrfr = {
	-- libtrippin
	starrydir.."/thirdparty/libtrippin/trippin/collection.cpp",
	starrydir.."/thirdparty/libtrippin/trippin/common.cpp",
	starrydir.."/thirdparty/libtrippin/trippin/iofs.cpp",
	starrydir.."/thirdparty/libtrippin/trippin/log.cpp",
	starrydir.."/thirdparty/libtrippin/trippin/math.cpp",
	starrydir.."/thirdparty/libtrippin/trippin/memory.cpp",
	starrydir.."/thirdparty/libtrippin/trippin/string.cpp",
	starrydir.."/thirdparty/libtrippin/trippin/error.cpp",

	-- starry3d
	starrydir.."/starry/app.cpp",
	starrydir.."/starry/gpu.cpp",
	starrydir.."/starry/internal.cpp",
	starrydir.."/starry/render.cpp",
	starrydir.."/starry/world.cpp",
}

-- imgui
if imgui_enabled then
	table.insert(srcsfrfr, starrydir.."/starry/optional/imgui.cpp")
	table.insert(srcsfrfr, starrydir.."/thirdparty/imgui/imgui.cpp")
	table.insert(srcsfrfr, starrydir.."/thirdparty/imgui/imgui_widgets.cpp")
	table.insert(srcsfrfr, starrydir.."/thirdparty/imgui/imgui_tables.cpp")
	table.insert(srcsfrfr, starrydir.."/thirdparty/imgui/imgui_draw.cpp")
	table.insert(srcsfrfr, starrydir.."/thirdparty/imgui/imgui_demo.cpp")
	table.insert(srcsfrfr, starrydir.."/thirdparty/imgui/backends/imgui_impl_glfw.cpp")
	table.insert(srcsfrfr, starrydir.."/thirdparty/imgui/backends/imgui_impl_opengl3.cpp")
	cflags = cflags.." -DST_IMGUI"
end

-- custom sources
for _, src in ipairs(srcs) do
	table.insert(srcsfrfr, src)
end

-- ldflags
ldflags = "-Lbuild/glfw/src"
if platform == "windows" then
	ldflags = ldflags.." -lglfw3 -lopengl32 -lgdi32 -lwinmm -lcomdlg32 -lole32 -lpthread -lstdc++ -static"
else
	ldflags = ldflags.." -lglfw3 -lX11 -lXrandr -lGL -lXinerama -lm -lpthread -ldl -lrt -lstdc++"
end

-- man.
if compmode == "debug" then
	cflags = cflags.." -O0 -g -DDEBUG -D_DEBUG"
else
	cflags = cflags.." -O2 -g"
end

if sanitize ~= "" then
	cflags = cflags.." -fsanitize="..sanitize
	ldflags = ldflags.." -fsanitize="..sanitize
end

--------------------------------------------------
--- GENERATE THE BUILD FILES FRFRFR ONG NO CAP ---
--------------------------------------------------

local f = io.open("build.ninja", "w")
assert(f)

f:write("# Autogenerated by configure.lua. You probably shouldn't edit this.\n")
f:write("cxx = "..cxx.."\n")
f:write("cflags = "..cflags.."\n")
f:write("ldflags = "..ldflags.."\n")

f:write("\nrule glfw_build\n")
if platform == "windows" then
	f:write("  command = "..
			"mkdir "..builddir.."/glfw -p && "..
			-- cmake can't find a file that exists :D
			"cp "..starrydir.."/thirdparty/glfw/CMake/x86_64-w64-mingw32.cmake "..builddir.."/win32.cmake && "..
			"cmake -S "..starrydir.."/thirdparty/glfw -B "..builddir.."/glfw -D GLFW_LIBRARY_TYPE=STATIC -D GLFW_BUILD_EXAMPLES=OFF -D GLFW_BUILD_TESTS=OFF -DCMAKE_TOOLCHAIN_FILE=$$(pwd)/"..builddir.."/win32.cmake && "..
			"cd "..builddir.."/glfw && "..
			"make && "..
			"mv src/libglfw3.a src/glfw3.lib"
	)
else
	f:write("  command = "..
			"mkdir "..builddir.."/glfw -p && "..
			"cmake -S "..starrydir.."/thirdparty/glfw -B "..builddir.."/glfw -D GLFW_LIBRARY_TYPE=STATIC -D GLFW_BUILD_EXAMPLES=OFF -D GLFW_BUILD_TESTS=OFF && "..
			"cd "..builddir.."/glfw && "..
			"make"
	)
end
f:write("\n  description = Compiling GLFW\n")

f:write("\nrule compile\n")
f:write("  command = $cxx $cflags -c $in -o $out\n")
f:write("  description = Compiling $in\n")

f:write("\nrule link\n")
f:write("  command = $cxx $in $ldflags -o $out && " ..
	-- that's to copy assets :)
	"mkdir "..assetsdst.." -p && cp -r "..assetssrc.."/* "..assetsdst.."\n")
f:write("  description = Linking $out\n")

-- man
f:write("\nbuild "..builddir.."/glfw/libglfw3.a: glfw_build\n")

-- build crap :)
for _, src in ipairs(srcsfrfr) do
	f:write("build "..builddir.."/obj/"..src:gsub("%.cpp", ".o"):gsub("/", "_") ..
		": compile "..src.."\n")
end

-- link crap :)
f:write("\nbuild "..builddir.."/bin/"..project..": link ")
for _, src in ipairs(srcsfrfr) do
	f:write(builddir.."/obj/"..src:gsub("%.cpp", ".o"):gsub("/", "_").." ")
end
f:write("| "..builddir.."/glfw/libglfw3.a\n")

f:write("\ndefault "..builddir.."/bin/"..project.."\n")

f:close()

------------------
--- ITS JOEVER ---
------------------

io.write("Generated build.ninja; run `ninja` to compile\n")

if compile_commands == "y" then
	os.execute("ninja -t compdb > compile_commands.json")
end
